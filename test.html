<!doctype html>
<html>
<head>
  <title>Title</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="key, words">
  <meta name="description" content="Description.">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
  <style>
body { margin: 0 }
  </style>
</head>
<body>
  <!-- html content goes here -->
  <script>
// Utilities
//   $ enhances querySelectorAll
const $ = Object.assign((sel, node = document) => [...node.querySelectorAll(sel).values()], {

//   $.Machine creates state machines for the page
  Machine: function (state) {
    let es = {}, v = Object.values, r = Promise.resolve.bind(Promise); Object.seal(state);
    return Object.assign(this, {
      getState () { return state },
      on (e, fn) { (es[e] = es[e] || {})[fn.name] = fn; return this },
      stop (e, fname = '') { e in es && delete es[e][fname]; return this },
      emit (e, ...args) { return e in es && v(es[e]).reduce((s, fn) => (fn.apply(s, args), s), state) },
      emitAsync (e, ...args) { return e in es && v(es[e]).reduce((p, fn) => p.then(s => r(fn.apply(s, args)).then(() => s)), r(state)) } }) },

//   $.targets adds event listeners to nested objects, indexed by regex
  targets (obj, target = window) {
    let p, use = (m, fn) => { for (let es = p.split(' '), i = 0; i < es.length; i++) target[m](es[i], fn) };
    for (p in obj) if (Function.prototype.isPrototypeOf(obj[p])) {
      if (EventTarget.prototype.isPrototypeOf(target)) use('addEventListener', obj[p].bind(target));
      else if ($.Machine.prototype.isPrototypeOf(target)) use('on', obj[p])
    } else if (p in target) $.targets(obj[p], target[p]);
    else for (let k in target) if (k.match(new RegExp(`^${p}$`))) $.targets(obj[p], target[k]) },

//   $.queries adds event listeners to DOM nodes, indexed by selector
  queries (obj, node) {
    for (let q in obj) for (let e in obj[q]) for (let ns = $(q, node) || [], es = e.split(' '), i = 0; i < es.length; i++)
      ns.forEach(n => n.addEventListener(es[i], obj[q][e].bind(n))) },

//   $.load enhances importNode
  load (id, dest = 'body') { $(dest).forEach(n => n.appendChild(document.importNode($('template#' + id)[0].content, true))) } })

// Page state
var app1 = new $.Machine({ a: 1 }),
    app2 = { b: new $.Machine({ c: 2 })};

// Events
$.targets({
  load () {
    console.log('hello');
    app1.emit('test1');
    app2.b.emit('test2')
  },
  app1: { test1 () { console.log('pass1', this.a) } },
  app2: { b: { test2 () { console.log('pass2', this.c) } } }
});
$.queries({})
  </script>
  <noscript><h6>Only viewable with JavaScript enabled.</h6></noscript>
</body>
</html>
